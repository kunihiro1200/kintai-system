# 実装計画

- [x] 1. プロジェクトのセットアップとデータベース構築





  - Next.js 14プロジェクトの初期化（App Router、TypeScript）
  - Supabaseプロジェクトの作成と接続設定
  - データベーステーブル（staffs、attendance_records）の作成
  - Row Level Security (RLS) ポリシーの設定
  - _要件: 4.1, 8.2_

- [x] 2. 型定義とユーティリティの実装



  - TypeScript型定義（Staff、AttendanceRecord、APIレスポンス）の作成
  - 日付・時刻処理ユーティリティ関数の実装
  - _要件: 4.1_

- [x] 3. 残業計算ロジックの実装



  - OvertimeCalculatorクラスの実装
  - 標準労働時間取得メソッド（月曜/その他の判定）
  - 実労働時間計算メソッド（休憩1時間控除）
  - 残業時間計算メソッド
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ]* 3.1 残業計算ロジックのユニットテスト
  - 月曜日の標準時間計算テスト
  - 月曜以外の標準時間計算テスト
  - 休憩時間控除のテスト
  - 残業時間計算のテスト（残業あり/なし）
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ]* 3.2 プロパティテスト: 月曜日の標準労働時間
  - **プロパティ 11: 月曜日の標準労働時間**
  - **検証対象: 要件 5.1**

- [ ]* 3.3 プロパティテスト: 月曜以外の標準労働時間
  - **プロパティ 12: 月曜以外の標準労働時間**
  - **検証対象: 要件 5.2**

- [ ]* 3.4 プロパティテスト: 休憩時間の自動控除
  - **プロパティ 13: 休憩時間の自動控除**
  - **検証対象: 要件 5.3**

- [ ]* 3.5 プロパティテスト: 残業時間の正確な計算
  - **プロパティ 14: 残業時間の正確な計算**
  - **検証対象: 要件 5.4**

- [ ]* 3.6 プロパティテスト: 残業なしの場合はゼロ
  - **プロパティ 15: 残業なしの場合はゼロ**
  - **検証対象: 要件 5.5**

- [x] 4. Google認証の実装



  - Supabase AuthのGoogle OAuth設定
  - AuthProviderコンポーネントの実装
  - 認証状態管理とセッション維持
  - 未認証時のリダイレクト処理
  - _要件: 3.1, 3.2, 3.5_

- [x] 5. スタッフ管理機能の実装




  - スタッフデータアクセス層の実装
  - メールアドレスによるスタッフ検索機能
  - スタッフ作成・更新機能
  - メールアドレス一意性検証
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ]* 5.1 プロパティテスト: スタッフメールアドレスの一意性
  - **プロパティ 8: スタッフメールアドレスの一意性**
  - **検証対象: 要件 4.2**

- [ ]* 5.2 プロパティテスト: スタッフ情報更新のラウンドトリップ
  - **プロパティ 9: スタッフ情報更新のラウンドトリップ**
  - **検証対象: 要件 4.3**

- [ ]* 5.3 プロパティテスト: メールアドレスによるスタッフ検索
  - **プロパティ 10: メールアドレスによるスタッフ検索**
  - **検証対象: 要件 4.4**




- [ ] 6. 認証とスタッフ照合の実装
  - 認証後のメールアドレス取得処理
  - スタッフ記録との照合ロジック
  - 未登録メールアドレスのアクセス拒否処理
  - _要件: 3.3, 3.4_

- [ ]* 6.1 プロパティテスト: 認証されたメールアドレスとスタッフの照合
  - **プロパティ 6: 認証されたメールアドレスとスタッフの照合**
  - **検証対象: 要件 3.3**




- [ ]* 6.2 プロパティテスト: 未登録メールアドレスの拒否
  - **プロパティ 7: 未登録メールアドレスの拒否**
  - **検証対象: 要件 3.4**

- [ ] 7. 勤怠記録サービス層の実装
  - AttendanceServiceクラスの実装
  - 出勤記録作成メソッド（createClockIn）
  - 退勤記録更新メソッド（updateClockOut）
  - 当日の記録取得メソッド（getTodayRecord）
  - 重複チェックメソッド
  - _要件: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4_

- [ ]* 7.1 プロパティテスト: 出勤記録の永続化ラウンドトリップ
  - **プロパティ 1: 出勤記録の永続化ラウンドトリップ**
  - **検証対象: 要件 1.3**

- [ ]* 7.2 プロパティテスト: 出勤の重複防止
  - **プロパティ 2: 出勤の重複防止**
  - **検証対象: 要件 1.4**

- [ ]* 7.3 プロパティテスト: 退勤は既存レコードを更新
  - **プロパティ 3: 退勤は既存レコードを更新**
  - **検証対象: 要件 2.2**

- [x]* 7.4 プロパティテスト: 出勤なしの退勤はエラー



  - **プロパティ 4: 出勤なしの退勤はエラー**
  - **検証対象: 要件 2.3**

- [x]* 7.5 プロパティテスト: 退勤の重複防止



  - **プロパティ 5: 退勤の重複防止**
  - **検証対象: 要件 2.4**

- [x] 8. 出勤APIエンドポイントの実装



  - POST /api/attendance/clock-in の実装
  - 認証情報の取得とスタッフIDの特定
  - 重複チェックとエラーハンドリング
  - 成功レスポンスの返却
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 9. 退勤APIエンドポイントの実装
  - POST /api/attendance/clock-out の実装
  - 当日の出勤記録の確認
  - 退勤時刻の更新と労働時間・残業時間の計算
  - エラーハンドリング（未出勤、重複退勤）
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 10. 現在のステータス取得APIの実装
  - GET /api/attendance/current の実装



  - 当日の記録取得とステータス判定
  - 未出勤/出勤中/退勤済みの状態返却
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [ ]* 10.1 プロパティテスト: ステータス表示の正確性
  - **プロパティ 19: ステータス表示の正確性**
  - **検証対象: 要件 7.1**

- [ ]* 10.2 プロパティテスト: 出勤後のステータス更新
  - **プロパティ 20: 出勤後のステータス更新**
  - **検証対象: 要件 7.2, 7.5**

- [ ]* 10.3 プロパティテスト: 退勤後のステータス更新
  - **プロパティ 21: 退勤後のステータス更新**
  - **検証対象: 要件 7.3, 7.5**

- [x] 11. 勤怠履歴取得APIの実装






  - GET /api/attendance/history の実装
  - スタッフIDによる履歴取得
  - 日付範囲フィルタリング
  - 日付降順ソート
  - ページネーション



  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ]* 11.1 プロパティテスト: 勤怠履歴の完全性
  - **プロパティ 16: 勤怠履歴の完全性**
  - **検証対象: 要件 6.1**




- [ ]* 11.2 プロパティテスト: 勤怠記録の降順ソート
  - **プロパティ 17: 勤怠記録の降順ソート**
  - **検証対象: 要件 6.3**




- [ ]* 11.3 プロパティテスト: 日付範囲フィルタリング
  - **プロパティ 18: 日付範囲フィルタリング**
  - **検証対象: 要件 6.5**

- [ ] 12. チェックポイント - バックエンドテスト確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [ ] 13. メイン画面UIの実装
  - ホームページの作成
  - StatusDisplayコンポーネントの実装



  - AttendanceButtonコンポーネントの実装
  - 出勤/退勤ボタンのクリックハンドラー
  - ステータスのリアルタイム更新
  - _要件: 1.5, 2.5, 7.1, 7.2, 7.3, 7.4, 7.5_




- [ ] 14. 勤怠履歴画面UIの実装
  - 履歴ページの作成
  - AttendanceHistoryコンポーネントの実装
  - 日付範囲フィルターの実装
  - 不完全な記録の表示処理
  - ページネーション
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 15. エラーハンドリングとユーザーフィードバックの実装
  - エラーメッセージの日本語化
  - トースト通知コンポーネントの実装
  - 各種エラーケースの適切な表示
  - ローディング状態の表示
  - _要件: 1.4, 1.5, 2.3, 2.4, 2.5, 3.4, 8.5_

- [ ] 16. 並行アクセス処理の実装とテスト
  - データベーストランザクションの適切な使用
  - 競合更新の防止ロジック
  - エラー時のロールバック処理
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [ ]* 16.1 プロパティテスト: 並行アクセスの独立性
  - **プロパティ 22: 並行アクセスの独立性**
  - **検証対象: 要件 8.1**

- [ ]* 16.2 プロパティテスト: 競合更新の防止
  - **プロパティ 23: 競合更新の防止**
  - **検証対象: 要件 8.3**

- [ ] 17. 環境変数とデプロイ設定
  - .env.local ファイルの設定
  - Vercelプロジェクトの作成と接続
  - 環境変数の設定（Vercel）
  - GitHubリポジトリとの連携
  - _要件: すべて_

- [ ] 18. 最終チェックポイント - 全体テスト
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [x] 19. システム管理者機能の実装
  - staffsテーブルにis_system_adminカラムを追加するマイグレーション作成
  - システム管理者の一意性制約の追加
  - StaffServiceにシステム管理者関連メソッドの実装
  - システム管理者の設定・取得機能
  - _要件: 10.1, 10.6_

- [ ]* 19.1 プロパティテスト: システム管理者の一意性
  - **プロパティ 24: システム管理者の一意性**
  - **検証対象: 要件 10.6**

- [x] 20. Google Sheets連携サービスの実装
  - GoogleSheetsServiceクラスの実装
  - システム管理者のトークン取得メソッド
  - トークン検証メソッド
  - スプレッドシートからスタッフ情報取得メソッド
  - _要件: 10.1, 10.2, 10.5_

- [ ]* 20.1 プロパティテスト: システム管理者トークンの使用
  - **プロパティ 25: システム管理者トークンの使用**
  - **検証対象: 要件 10.2**

- [ ]* 20.2 プロパティテスト: システム管理者トークン不在時のエラー
  - **プロパティ 26: システム管理者トークン不在時のエラー**
  - **検証対象: 要件 10.4**

- [x] 21. スタッフ同期APIの更新
  - POST /api/staff/sync の実装を更新
  - システム管理者のトークンを使用するように変更
  - トークン不在・期限切れのエラーハンドリング
  - 同期結果の返却
  - _要件: 10.2, 10.4, 10.5_

- [x] 22. システム管理者ステータスAPIの実装
  - GET /api/staff/system-admin-status の実装
  - 現在のシステム管理者情報の取得
  - Google連携状態の確認
  - _要件: 10.7_

- [ ]* 22.1 プロパティテスト: システム管理者ステータスの正確性
  - **プロパティ 27: システム管理者ステータスの正確性**
  - **検証対象: 要件 10.7**

- [x] 23. スタッフ管理画面UIの更新
  - システム管理者の表示
  - Google連携状態の表示
  - システム管理者設定機能のUI
  - トークン不在・期限切れ時の警告表示
  - _要件: 10.3, 10.4, 10.5, 10.7_

- [x] 24. Google Calendar連携の更新
  - システム管理者がGoogle連携した際のトークン保存処理
  - 個人Gmailアカウントでの連携を許可
  - _要件: 10.1, 10.3_

- [x] 25. チェックポイント - システム管理者機能テスト
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [x] 26. 最終統合テスト
  - 組織アカウントでのログイン確認
  - システム管理者の個人Gmailでの連携確認
  - スタッフ同期機能の動作確認
  - エラーケースの確認
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7_

- [x] 27. 6ヶ月以内社員休暇タイプの追加
  - 型定義に`new_employee_leave`を追加
  - データベースのleave_type制約を更新（必要に応じて）
  - LeaveSummaryインターフェースに`new_employee_leave_count`を追加
  - _要件: 11.1, 11.2_

- [ ]* 27.1 プロパティテスト: 6ヶ月以内社員休暇の記録
  - **プロパティ 28: 6ヶ月以内社員休暇の記録**
  - **検証対象: 要件 11.1**

- [ ]* 27.2 プロパティテスト: 6ヶ月以内社員休暇は出退勤記録を作成しない
  - **プロパティ 29: 6ヶ月以内社員休暇は出退勤記録を作成しない**
  - **検証対象: 要件 11.2**

- [x] 28. 6ヶ月以内社員休暇のAPI実装
  - POST /api/attendance/leave エンドポイントに`new_employee_leave`タイプを追加
  - GET /api/attendance/leave-summary に`new_employee_leave_count`を追加
  - GET /api/attendance/all-staff-summary に`new_employee_leave_count`を追加
  - _要件: 11.1, 11.4, 11.5_

- [ ]* 28.1 プロパティテスト: 6ヶ月以内社員休暇の履歴表示
  - **プロパティ 30: 6ヶ月以内社員休暇の履歴表示**
  - **検証対象: 要件 11.3**

- [ ]* 28.2 プロパティテスト: 6ヶ月以内社員休暇のカウント表示
  - **プロパティ 31: 6ヶ月以内社員休暇のカウント表示**
  - **検証対象: 要件 11.4**

- [ ]* 28.3 プロパティテスト: 管理画面での6ヶ月以内社員休暇表示
  - **プロパティ 32: 管理画面での6ヶ月以内社員休暇表示**
  - **検証対象: 要件 11.5**

- [x] 29. メイン画面UIに6ヶ月以内社員休暇ボタンを追加
  - 「休暇（6ヶ月以内社員）」ボタンの追加
  - LeaveModalコンポーネントで`new_employee_leave`タイプをサポート
  - 6ヶ月以内社員休暇カウントの表示
  - _要件: 11.1, 11.4_

- [x] 30. 管理画面UIに6ヶ月以内社員休暇列を追加
  - 全社員サマリーテーブルに「休暇（6ヶ月以内社員）」列を追加
  - 6ヶ月以内社員休暇カウントの表示
  - クリック時の日付一覧モーダル表示
  - _要件: 11.5, 11.6_

- [x] 31. チェックポイント - 6ヶ月以内社員休暇機能テスト
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [x] 32. 最終統合テスト - 6ヶ月以内社員休暇
  - 6ヶ月以内社員休暇の記録確認
  - メイン画面でのカウント表示確認
  - 管理画面での表示確認
  - 日付一覧モーダルの動作確認
  - _要件: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6_
