# 非アクティブなスタッフの確実な除外手順（本番環境）

## 問題
tenant と フレックス（oitaifoo@gmail.com）が全社員勤怠サマリーに表示されている

## 解決手順（本番環境 - Vercel）

### 1. データベースの状態を確認

Supabase ダッシュボード → SQL Editor で以下を実行：

```sql
-- is_active の状態を確認
SELECT 
  id,
  name,
  email,
  is_active,
  created_at
FROM staffs
WHERE email IN ('tenant@ifoo-oita.com', 'oitaifoo@gmail.com')
ORDER BY email;
```

### 2. 非アクティブ化を実行

もし `is_active` が `true` のままなら、以下を実行：

```sql
-- tenant と フレックスを非アクティブ化
UPDATE staffs 
SET is_active = false 
WHERE email IN ('tenant@ifoo-oita.com', 'oitaifoo@gmail.com');
```

実行後、以下のメッセージが表示されることを確認：
```
Success. No rows returned
```
または
```
UPDATE 2
```

### 3. 更新を確認

```sql
-- 更新されたか確認
SELECT 
  name,
  email,
  is_active
FROM staffs
WHERE email IN ('tenant@ifoo-oita.com', 'oitaifoo@gmail.com');
```

結果が以下のようになっていることを確認：
- tenant: is_active = false
- フレックス: is_active = false

### 4. アプリケーションで確認（サーバー再起動不要）

**重要**: Vercelの場合、データベースを更新するだけで即座に反映されます。サーバーの再起動は不要です。

1. **ブラウザのキャッシュをクリア**
   - Chrome: Ctrl+Shift+Delete → キャッシュをクリア
   - または、シークレットモード（Ctrl+Shift+N）で開く

2. **管理画面で確認**
   - 本番環境のURL（例: https://your-app.vercel.app/admin）にアクセス
   - 全社員勤怠サマリーを表示
   - tenant と フレックスが表示されないことを確認

3. **スタッフ管理画面で確認**
   - `/staff` にアクセス
   - tenant と フレックスが「非アクティブ」として表示されることを確認

### 5. コンソールログを確認（オプション）

ブラウザの開発者ツール（F12）→ Console タブで以下を確認：
- 「全社員サマリー - 取得したスタッフ数」のログ
- tenant と フレックスが含まれていないことを確認

### 6. それでも表示される場合

#### A. ブラウザのハードリフレッシュ
- Windows/Linux: Ctrl+Shift+R
- Mac: Cmd+Shift+R

#### B. APIレスポンスを直接確認
ブラウザで以下のURLにアクセス：
```
https://your-app.vercel.app/api/attendance/all-staff-summary
```

レスポンスに tenant と フレックスが含まれているか確認

#### C. データベースを再確認
```sql
-- すべてのスタッフの is_active を確認
SELECT name, email, is_active 
FROM staffs 
ORDER BY is_active DESC, name;
```

## トラブルシューティング

### それでも表示される場合

1. **RLSポリシーを確認**
   ```sql
   -- staffs テーブルのポリシーを確認
   SELECT * FROM pg_policies WHERE tablename = 'staffs';
   ```

2. **手動でデータを確認**
   ```sql
   -- すべてのスタッフの is_active を確認
   SELECT name, email, is_active 
   FROM staffs 
   ORDER BY is_active DESC, name;
   ```

3. **APIレスポンスを直接確認**
   - ブラウザで `/api/attendance/all-staff-summary` にアクセス
   - レスポンスに tenant と フレックスが含まれているか確認
