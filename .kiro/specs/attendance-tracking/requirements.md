# 要件定義書

## はじめに

勤怠管理アプリケーションは、スタッフの出退勤時刻を記録し、労働時間と残業時間を自動計算するシステムです。Google認証を使用してスタッフを識別し、出退勤ボタンのワンクリックで日時を記録します。数十人規模のチームでの使用を想定しています。

## 用語集

- **システム**: 勤怠管理アプリケーション
- **スタッフ**: システムを使用する従業員
- **出勤打刻**: 出勤時刻の記録
- **退勤打刻**: 退勤時刻の記録
- **勤怠記録**: 特定の日付における1人のスタッフの出退勤記録
- **標準労働時間**: 標準労働時間（月曜：9:00-18:00、その他：9:30-18:00）
- **残業時間**: 標準労働時間を超えた労働時間（休憩1時間を自動控除）
- **Googleアカウント**: スタッフ認証に使用されるGoogleアカウント
- **有給休暇**: スタッフが取得する有給の休暇（1日単位でカウント）
- **半休**: 半日の有給休暇（0.5日単位でカウント）
- **代休**: 休日出勤の代わりに取得する休暇
- **休日出勤**: 通常の休日に出勤すること
- **システム管理者**: Google Sheets APIアクセスのための個人Gmailトークンを提供する特別な権限を持つスタッフ
- **組織アカウント**: スタッフがログインに使用する組織のGoogleアカウント（例：@ifoo-oita.com）
- **個人Gmailアカウント**: システム管理者がGoogle API連携に使用する個人のGmailアカウント

## 要件

### 要件 1

**ユーザーストーリー:** スタッフとして、ボタン1つで出勤時刻を記録したい。手動入力なしで素早く到着を記録できるようにするため。

#### 受入基準

1. WHEN スタッフが出勤ボタンをクリックした時、THE システム SHALL 現在の日時を出勤時刻として記録する
2. WHEN スタッフが出勤ボタンをクリックした時、THE システム SHALL 記録を認証済みのGoogleアカウントに紐付ける
3. WHEN 出勤が記録された時、THE システム SHALL データを即座にデータベースに保存する
4. IF スタッフが当日既に出勤済みの状態で出勤しようとした時、THEN THE システム SHALL 重複入力を防止しエラーメッセージを表示する
5. WHEN 出勤が成功した時、THE システム SHALL 記録された時刻と共に確認メッセージを表示する

### 要件 2

**ユーザーストーリー:** スタッフとして、ボタン1つで退勤時刻を記録したい。手動入力なしで素早く退勤を記録できるようにするため。

#### 受入基準

1. WHEN スタッフが退勤ボタンをクリックした時、THE システム SHALL 現在の日時を退勤時刻として記録する
2. WHEN スタッフが退勤ボタンをクリックした時、THE システム SHALL 当日の既存の勤怠記録を更新する
3. IF スタッフが当日出勤していない状態で退勤しようとした時、THEN THE システム SHALL 操作を防止しエラーメッセージを表示する
4. IF スタッフが当日既に退勤済みの状態で退勤しようとした時、THEN THE システム SHALL 重複入力を防止しエラーメッセージを表示する
5. WHEN 退勤が成功した時、THE システム SHALL 記録された時刻と共に確認メッセージを表示する

### 要件 3

**ユーザーストーリー:** スタッフとして、Googleアカウントで認証したい。システムが私を識別し、勤怠記録を私のIDに紐付けられるようにするため。

#### 受入基準

1. WHEN スタッフがアプリケーションにアクセスした時、THE システム SHALL Google認証を要求する
2. WHEN スタッフがGoogle認証を完了した時、THE システム SHALL Googleアカウントからメールアドレスを取得する
3. WHEN 認証が成功した時、THE システム SHALL メールアドレスをデータベース内のスタッフ記録と照合する
4. IF 認証されたメールアドレスがどのスタッフ記録とも一致しない時、THEN THE システム SHALL アクセスを拒否しエラーメッセージを表示する
5. WHEN スタッフが認証された時、THE システム SHALL 明示的なログアウトまたはセッション期限切れまでセッションを維持する

### 要件 4

**ユーザーストーリー:** 管理者として、Gmailアドレスを含むスタッフ情報を管理したい。誰がシステムにアクセスできるかを制御できるようにするため。

#### 受入基準

1. THE システム SHALL 一意の識別子、名前、Gmailアドレスを持つスタッフ記録を保存する
2. WHEN 新しいスタッフが追加された時、THE システム SHALL Gmailアドレスが一意であることを検証する
3. WHEN スタッフ情報が更新された時、THE システム SHALL 変更を即座にデータベースに保存する
4. THE システム SHALL 認証照合のためにGmailアドレスでスタッフ情報を取得できるようにする
5. WHEN スタッフ記録が照会された時、THE システム SHALL 関連するすべての勤怠記録を返す

### 要件 5

**ユーザーストーリー:** スタッフとして、システムに残業時間を自動計算してほしい。どれだけ余分に働いたかを追跡できるようにするため。

#### 受入基準

1. WHEN 月曜日の残業を計算する時、THE システム SHALL 標準開始時刻として9:00、標準終了時刻として18:00を使用する
2. WHEN 火曜日から日曜日の残業を計算する時、THE システム SHALL 標準開始時刻として9:30、標準終了時刻として18:00を使用する
3. WHEN 労働時間を計算する時、THE システム SHALL 昼休憩として1時間を自動的に差し引く
4. WHEN 実際の労働時間が標準労働時間を超える時、THE システム SHALL その差を残業時間として計算する
5. WHEN 実際の労働時間が標準労働時間以下の時、THE システム SHALL 残業時間をゼロに設定する

### 要件 6

**ユーザーストーリー:** スタッフとして、勤怠履歴を閲覧したい。過去の出退勤時刻を確認できるようにするため。

#### 受入基準

1. WHEN スタッフが勤怠履歴を要求した時、THE システム SHALL そのスタッフのすべての勤怠記録を表示する
2. WHEN 勤怠記録を表示する時、THE システム SHALL 日付、出勤時刻、退勤時刻、総労働時間、残業時間を表示する
3. WHEN 勤怠記録を表示する時、THE システム SHALL 日付の降順でソートする
4. WHEN 勤怠記録に退勤時刻がない時、THE システム SHALL その記録が不完全であることを示す
5. THE システム SHALL 日付範囲で勤怠記録をフィルタリングできるようにする

### 要件 7

**ユーザーストーリー:** スタッフとして、メイン画面で現在のステータスを見たい。現在出勤中か退勤済みかを知るため。

#### 受入基準

1. WHEN スタッフがメイン画面を表示した時、THE システム SHALL 現在出勤中か退勤済みかを表示する
2. WHEN スタッフが出勤中の時、THE システム SHALL 当日の出勤時刻を表示する
3. WHEN スタッフが退勤済みの時、THE システム SHALL 当日の出勤時刻と退勤時刻の両方を表示する
4. WHEN スタッフが当日まだ出勤していない時、THE システム SHALL 本日の記録がないことを示すメッセージを表示する
5. THE システム SHALL 出勤または退勤操作の直後にステータス表示を更新する

### 要件 8

**ユーザーストーリー:** システムとして、複数のスタッフからの同時アクセスを処理したい。勤怠記録が正確で一貫性を保つようにするため。

#### 受入基準

1. WHEN 複数のスタッフが同時にシステムにアクセスした時、THE システム SHALL 各リクエストを独立して処理する
2. WHEN データベース操作が実行される時、THE システム SHALL トランザクションの一貫性を保証する
3. WHEN スタッフの勤怠記録が更新されている時、THE システム SHALL 同じ記録への競合する更新を防止する
4. WHEN データベースエラーが発生した時、THE システム SHALL 不完全なトランザクションをロールバックする
5. WHEN 操作が失敗した時、THE システム SHALL ユーザーに明確なエラーメッセージを提供する

### 要件 9

**ユーザーストーリー:** スタッフとして、有給休暇、代休、半休、休日出勤を記録したい。特別な勤務形態を正確に管理できるようにするため。

#### 受入基準

1. WHEN スタッフが有給休暇ボタンをクリックした時、THE システム SHALL 当日を有給休暇として記録し、有給カウントを1増やす
2. WHEN スタッフが半休ボタンをクリックした時、THE システム SHALL 当日を半休として記録し、有給カウントを0.5増やす
3. WHEN スタッフが代休ボタンをクリックした時、THE システム SHALL 当日を代休として記録し、代休カウントを1増やす
4. WHEN スタッフが休日出勤ボタンをクリックした時、THE システム SHALL 当日を休日出勤として記録し、休日出勤カウントを1増やす
5. WHEN 休暇や休日出勤が記録された時、THE システム SHALL 通常の出退勤記録を作成せず、休暇タイプのみを記録する
6. WHEN スタッフが履歴を閲覧した時、THE システム SHALL 有給休暇、代休、半休、休日出勤の記録を通常の勤怠記録と共に表示する
7. WHEN スタッフがメイン画面を表示した時、THE システム SHALL 有給休暇、代休、半休、休日出勤の累計カウントを表示する

### 要件 10

**ユーザーストーリー:** 管理者として、個人Gmailアカウントを使ってGoogle Sheetsからスタッフ情報を同期したい。組織アカウントではGoogle APIが利用できないため、システム管理者の個人アカウントのトークンを使用できるようにするため。

#### 受入基準

1. THE システム SHALL システム管理者として指定された特定のスタッフのGoogleトークンを保存する
2. WHEN 管理者がGoogle Sheetsからスタッフ情報を同期する時、THE システム SHALL ログインユーザーのトークンではなく、システム管理者のトークンを使用する
3. WHEN システム管理者が個人GmailアカウントでGoogleカレンダー連携を行った時、THE システム SHALL そのトークンをシステム管理者用として保存する
4. WHEN システム管理者のトークンが存在しない時、THE システム SHALL スタッフ同期機能を無効化しエラーメッセージを表示する
5. WHEN システム管理者のトークンが期限切れの時、THE システム SHALL 再認証を要求するメッセージを表示する
6. THE システム SHALL システム管理者フラグを持つスタッフを1人のみ許可する
7. WHEN 管理者がスタッフ管理画面にアクセスした時、THE システム SHALL 現在のシステム管理者が誰か、およびGoogle連携状態を表示する

### 要件 11

**ユーザーストーリー:** 管理者として、入社6ヶ月以内の社員の休暇を別途記録したい。入社6ヶ月以内の社員は有給休暇がないため、休むと休日出勤で補填する必要があるため。

#### 受入基準

1. WHEN スタッフが「休暇（6ヶ月以内社員）」ボタンをクリックした時、THE システム SHALL 当日を6ヶ月以内社員休暇として記録し、6ヶ月以内社員休暇カウントを1増やす
2. WHEN 6ヶ月以内社員休暇が記録された時、THE システム SHALL 通常の出退勤記録を作成せず、休暇タイプのみを記録する
3. WHEN スタッフが履歴を閲覧した時、THE システム SHALL 6ヶ月以内社員休暇の記録を他の休暇記録と共に表示する
4. WHEN スタッフがメイン画面を表示した時、THE システム SHALL 6ヶ月以内社員休暇の累計カウントを表示する
5. WHEN 管理者が全社員サマリーを閲覧した時、THE システム SHALL 各社員の6ヶ月以内社員休暇カウントを表示する
6. WHEN 管理者が6ヶ月以内社員休暇カウントをクリックした時、THE システム SHALL その社員の6ヶ月以内社員休暇の日付一覧を表示する
